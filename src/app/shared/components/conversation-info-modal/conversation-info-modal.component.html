<div class="fixed flex items-center justify-center inset-0 z-[990] bg-black/60" (click)="onClose()" appEscClose
    (appEscClose)="onClose()">
    <div class="panel animate-modal-fade-in" (click)="onPanelClick($event)" (clickOutside)="onClose()">

        <div class="panel-header">
            <div class="header-left">
                <div class="avatar-container">
                    <img *ngIf="selectedAvatarPreview; else currentAvatar" [src]="selectedAvatarPreview"
                        class="group-avatar-lg" />

                    <ng-template #currentAvatar>
                        <img *ngIf="conversation?.avatarUrl; else placeholderAvatar" [src]="conversation.avatarUrl"
                            class="group-avatar-lg" />
                        <ng-template #placeholderAvatar>
                            <div class="group-avatar-placeholder">{{ (conversation?.name || '').charAt(0) || '?' }}
                            </div>
                        </ng-template>
                    </ng-template>

                    <div *ngIf="selectedAvatarPreview" class="preview-overlay">
                        <div class="preview-actions">
                            <button class="confirm-btn" (click)="confirmUploadAvatar()" [disabled]="uploadingAvatar">
                                <span *ngIf="!uploadingAvatar">✓</span>
                                <span *ngIf="uploadingAvatar" class="loading-spinner">⟳</span>
                            </button>
                            <button class="cancel-btn" (click)="clearAvatarPreview()"
                                [disabled]="uploadingAvatar">✕</button>
                        </div>
                    </div>
                </div>

                <div class="title-block">
                    <div class="group-name">{{ conversation?.name || 'Đoạn chat' }}</div>
                    <div class="group-meta">{{ participants.length || 0 }} thành viên</div>
                </div>
            </div>

            <div class="header-actions">
                <div class="relative" (click)="$event.stopPropagation()">
                    <button class="icon-btn cursor-pointer" title="Cài đặt đoạn chat"
                        (click)="toggleSettingsMenu($event)" aria-haspopup="true"
                        [attr.aria-expanded]="showSettingsMenu">
                        <i class="fa-solid fa-gear text-black text-xl"></i>
                    </button>

                    <div *ngIf="showSettingsMenu" #settingsDropdown
                        class="settings-dropdown absolute right-0 mt-2 w-60 bg-white rounded-xl shadow-xl border z-50 animate-fade-in px-2 border-gray-300"
                        (click)="$event.stopPropagation()" (clickOutside)="showSettingsMenu = false">
                        <ul class="py-2">
                            <li>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                                    (click)="onSettingsRename()">
                                    <i class="fa-solid fa-pen mr-3"></i> Đổi tên đoạn chat
                                </button>
                            </li>
                            <li>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                                    (click)="onSettingsChangeAvatar()">
                                    <i class="fa-solid fa-image mr-3"></i> Đổi ảnh đại diện
                                </button>
                            </li>
                            <li>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                                    (click)="onSettingsChangeTheme()">
                                    <i class="fa-solid fa-circle-half-stroke mr-3"></i> Đổi chủ đề
                                </button>
                            </li>
                            <li>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                                    (click)="onSettingsEditNicknames()">
                                    <i class="fa-solid fa-a mr-3"></i> Chỉnh sửa biệt danh
                                </button>
                            </li>
                            <li>
                                <button class="w-full text-left px-4 py-2 hover:bg-gray-50 rounded-lg cursor-pointer"
                                    (click)="onSettingsChangeEmoji()">
                                    <i class="fa-solid fa-face-smile mr-3"></i> Đổi biểu tượng cảm xúc
                                </button>
                            </li>
                        </ul>
                    </div>

                    <!-- hidden file input dedicated for change avatar -->
                    <input type="file" #settingsAvatarInput accept="image/*" hidden
                        (change)="onAvatarSelected($event)" />
                </div>
            </div>
        </div>

        <div class="section participants">
            <div class="flex justify-between">
                <h4 class="font-bold">Thành viên</h4>
                <button *ngIf="isGroup" class="text-sm text-blue-800 hover:underline cursor-pointer"
                    (click)="addMember()">Thêm
                    thành
                    viên</button>
            </div>
            <div class="list">
                <ng-container *ngFor="let p of participants">
                    <div class="participant-row">
                        <img [src]="p.avatarUrl || ('https://ui-avatars.com/api/?name=' + (p.fullName || p.username))"
                            class="avatar" />
                        <div class="meta">
                            <div class="fullname">
                                {{ p.fullName || p.username }}
                                <span *ngIf="isCurrentUser(p)" class="text-gray-400"> · Bạn</span>
                                <span *ngIf="isGroup && isOwner(p)" class="badge admin">Quản trị viên</span>
                            </div>
                            <div class="username">{{ '@' + p.username }}</div>
                        </div>
                        <div class="more" *ngIf="!isCurrentUser(p)">
                            <button class="more-btn text-gray-600" (click)="onParticipantMenu(p)">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>

        <div class="section actions">
            <div class="action-row">
                <button *ngIf="isGroup && isAdmin" class="danger" (click)="deleteChat()">Xóa nhóm chat</button>
                <button *ngIf="isGroup && !isAdmin" class="danger" (click)="leaveChat()">Rời khỏi nhóm</button>
                <button class="danger" (click)="leaveChat()">Xóa đoạn chat</button>
            </div>
        </div>
    </div>
</div>

<app-conversation-rename-modal *ngIf="showRenameModal" [conversation]="conversation" (saved)="onRenameSaved($event)"
    (close)="onRenameClosed()"></app-conversation-rename-modal>

<app-add-participants-modal *ngIf="showAddModal" [conversation]="conversation" [participants]="participants"
    (added)="onMembersAdded($event)" (close)="showAddModal = false">
</app-add-participants-modal>

<app-participant-menu-modal *ngIf="showParticipantMenu" [conversation]="conversation"
    [participant]="selectedParticipant" [isAdmin]="isAdmin" [currentUserId]="currentUserId"
    (acted)="onParticipantActed($event)" (close)="showParticipantMenu = false">
</app-participant-menu-modal>

<app-confirm-modal *ngIf="showLeaveConfirm" [show]="true" [title]="'Xác nhận rời nhóm'"
    [message]="'Bạn có chắc muốn rời khỏi nhóm này? Bạn sẽ không còn tham gia.'" [confirmText]="'Rời nhóm'"
    [cancelText]="'Hủy'" [confirmColor]="'text-red-600'" [zIndex]="999" (confirm)="confirmLeave()"
    (cancel)="showLeaveConfirm = false">
</app-confirm-modal>

<app-conversation-theme-modal *ngIf="showChangeThemeModal" [conversation]="conversation" (saved)="onThemeSaved($event)"
    (close)="showChangeThemeModal = false">
</app-conversation-theme-modal>

<app-conversation-emoji-modal *ngIf="showEmojiPickerModal" [conversation]="conversation" (saved)="onEmojiSaved($event)"
    (close)="showEmojiPickerModal = false">
</app-conversation-emoji-modal>