<div class="h-full flex flex-col">
    <div class="header flex items-center gap-3 px-4 py-3 border-b border-gray-200">
        <button class="md:hidden mr-2 text-gray-600 px-2 py-1 rounded hover:bg-gray-100 cursor-pointer"
            (click)="back()">
            <i class="fa-solid fa-arrow-left"></i>
        </button>

        <div class="flex items-center gap-3">
            <img (click)="navigateToProfile(router, username)" [src]="displayAvatar" alt="avatar"
                class="w-10 h-10 rounded-full object-cover cursor-pointer" />
            <div>
                <div (click)="navigateToProfile(router, username)" class="font-semibold truncate cursor-pointer"
                    style="max-width: 220px;">{{ displayName }}</div>
                <div (click)="navigateToProfile(router, username)" *ngIf="!isGroup"
                    class="text-xs text-gray-400 cursor-pointer">{{ "@" + username }}</div>
            </div>
        </div>

        <div class="ml-auto flex items-center gap-2 header-actions">
            <button class="icon-btn" title="Gọi thoại" (click)="callPhone()">
                <i class="fa-solid fa-phone text-gray-600"></i>
            </button>

            <button class="icon-btn" title="Gửi video" (click)="callVideo()">
                <i class="fa-solid fa-video text-gray-600"></i>
            </button>

            <button class="icon-btn" title="Thông tin về cuộc trò chuyện" (click)="openConversationInfo()">
                <i class="fa-solid fa-circle-info text-gray-600"></i>
            </button>
        </div>
    </div>

    <div class="messages flex-1 overflow-auto p-4" #messagesContainer (scroll)="onScroll($event)">
        <div *ngIf="isLoadingMessages && messages.length === 0" class="py-8">
            <app-loading></app-loading>
        </div>

        <div *ngIf="isLoadingMessages && messages.length > 0" class="py-2">
            <app-loading></app-loading>
        </div>

        <div *ngFor="let m of messages; trackBy: trackByMessageId; let i = index" class="message-row"
            [class.flex-row-reverse]="isMessageFromCurrentUser(m.senderId)"
            [style.margin-bottom]="getMessageMarginBottom(i)">

            <app-tooltip *ngIf="!isMessageFromCurrentUser(m.senderId ?? m.sender)"
                [text]="getSenderName(m.senderId ?? m.sender)">
                <img (click)="navigateToProfile(router, username)"
                    class="w-8 h-8 rounded-full object-cover flex-shrink-0 cursor-pointer"
                    [src]="getSenderAvatar(m.senderId)" alt="avatar" />
            </app-tooltip>

            <div class="max-w-xs lg:max-w-md">
                <div *ngIf="shouldShowSenderName(i) && isGroup" class="text-xs text-gray-500 mb-1 px-2"
                    [class.text-right]="isMessageFromCurrentUser(m.senderId)">
                    {{ getSenderName(m.senderId) }}
                </div>

                <div class="p-2 rounded-lg text-sm relative" [title]="'Đã gửi ' + formatTime(m.sentAt)"
                    [class.bg-blue-500]="isMessageFromCurrentUser(m.senderId)"
                    [class.text-white]="isMessageFromCurrentUser(m.senderId)"
                    [class.bg-gray-100]="!isMessageFromCurrentUser(m.senderId)"
                    [class.text-gray-800]="!isMessageFromCurrentUser(m.senderId)" [class.opacity-50]="m.isTemp"
                    [class.rounded-bl-sm]="!isMessageFromCurrentUser(m.senderId) && !shouldShowAvatar(i) && i < messages.length - 1"
                    [class.rounded-br-sm]="isMessageFromCurrentUser(m.senderId) && i < messages.length - 1 && shouldHaveGroupedCorner(i)">
                    {{ m.content }}

                    <i *ngIf="m.isTemp" class="fa-solid fa-clock text-xs absolute -bottom-1 -right-1 opacity-70"></i>
                </div>
            </div>
        </div>

        <div *ngIf="messages.length === 0 && !isLoadingMessages" class="py-8">
            <div *ngIf="messages.length === 0 && !isLoadingMessages" class="py-8">
                <ng-container *ngIf="isGroup; else singleEmpty">
                    <div class="text-sm text-gray-500 text-center">
                        Chưa có tin nhắn trong nhóm này. Hãy bắt đầu cuộc trò chuyện!
                    </div>
                </ng-container>

                <ng-template #singleEmpty>
                    <div class="flex flex-col items-center justify-center text-center text-gray-500">
                        <img [src]="displayAvatar" alt="avatar" class="w-24 h-24 rounded-full object-cover mb-2" />
                        <div class="text-lg font-semibold">{{ displayName }}</div>
                        <div class="text-sm text-gray-500 mb-4">{{ '@' + username || '' }}</div>
                        <button class="px-4 py-1 rounded-lg bg-black text-white text-sm font-semibold cursor-pointer"
                            (click)="navigateToProfile(router, username)">
                            Xem trang cá nhân
                        </button>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>

    <div class="composer">
        <div class="composer-inner">
            <div class="left">
                <button class="icon-btn" (click)="toggleEmojiPicker()" aria-label="Emoji">
                    <i class="fa-regular fa-face-smile"></i>
                </button>

                <div (clickOutside)="showEmojiPicker = false" class="emoji-panel" *ngIf="showEmojiPicker">
                    <emoji-mart (emojiSelect)="addEmoji($event)" [style.width.px]="320"
                        [style.height.px]="260"></emoji-mart>
                </div>
            </div>

            <div class="center">
                <textarea [(ngModel)]="text" name="text" rows="1" placeholder="Nhập tin nhắn..." class="message-input"
                    (input)="autoResize($event)" (keydown.enter)="$event.preventDefault(); send()"></textarea>
            </div>

            <div class="right">
                <ng-container *ngIf="!text?.trim(); else hasText">
                    <button class="icon-btn" (click)="startVoiceRecording()" title="Ghi âm">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <button class="icon-btn" (click)="openFilePicker()" title="Ảnh / Video">
                        <i class="fa-solid fa-image"></i>
                    </button>
                    <input #fileInput type="file" accept="image/*,video/*" (change)="onFileSelected($event)" hidden />

                    <button class="icon-btn" (click)="openStickerPicker()" title="Sticker">
                        <i class="fa-regular fa-face-smile-wink"></i>
                    </button>

                    <button class="icon-btn" (click)="quickHeart()" title="Gửi trái tim">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                </ng-container>

                <ng-template #hasText>
                    <button class="send-btn" (click)="send()">Gửi</button>
                </ng-template>
            </div>
        </div>
    </div>
</div>