<div class="h-full flex flex-col">
    <div class="header flex items-center gap-3 px-4 py-3 border-b border-gray-200">
        <button class=" md:hidden mr-2 text-gray-600 px-2 py-1 rounded hover:bg-gray-100 cursor-pointer"
            (click)="back()">
            <i class="fa-solid fa-arrow-left"></i>
        </button>

        <div class="flex items-center gap-3">
            <img (click)="!isGroup ? navigateToProfile(router, username) : null" [src]="displayAvatar" alt="avatar"
                class="w-10 h-10 rounded-full object-cover cursor-pointer" />
            <div>
                <div (click)="!isGroup ? navigateToProfile(router, username) : null"
                    class="font-semibold truncate cursor-pointer" style="max-width: 220px;">{{ displayName }}</div>
                <div (click)="!isGroup ? navigateToProfile(router, username) : null" *ngIf="!isGroup"
                    class="text-xs text-gray-400 cursor-pointer">{{ "@" + username }}</div>
            </div>
        </div>

        <div class="ml-auto flex items-center gap-2 header-actions">
            <button class="icon-btn" title="Gọi thoại" (click)="callPhone()">
                <i class="fa-solid fa-phone text-gray-600"></i>
            </button>

            <button class="icon-btn" title="Gửi video" (click)="callVideo()">
                <i class="fa-solid fa-video text-gray-600"></i>
            </button>

            <button class="icon-btn" title="Thông tin về cuộc trò chuyện" (click)="openConversationInfo()">
                <i class="fa-solid fa-circle-info text-gray-600"></i>
            </button>
        </div>
    </div>

    <div class="messages flex-1 overflow-auto p-4" #messagesContainer (scroll)="onScroll($event)">
        <div *ngIf="isLoadingMessages && messages.length === 0" class="py-8">
            <app-loading></app-loading>
        </div>

        <div *ngIf="isLoadingMessages && messages.length > 0" class="py-2">
            <app-loading></app-loading>
        </div>

        <div *ngFor="let m of messages; let i = index; trackBy: trackByMessageId" class="message-row"
            [class.flex-row-reverse]="isMessageFromCurrentUser(m.senderId)">
            <ng-container *ngIf="!isMessageFromCurrentUser(m.senderId ?? m.sender); else noAvatar">
                <app-tooltip *ngIf="shouldShowAvatar(i)" [text]="getSenderName(m.senderId ?? m.sender)">
                    <img (click)="navigateToProfile(router, username)"
                        class="w-8 h-8 rounded-full object-cover flex-shrink-0 cursor-pointer"
                        [src]="getSenderAvatar(m.senderId)" alt="avatar" />
                </app-tooltip>
                <div *ngIf="!shouldShowAvatar(i)" class="w-8 h-8 flex-shrink-0"></div>
            </ng-container>
            <ng-template #noAvatar></ng-template>

            <div class="max-w-xs lg:max-w-md message-bubble-wrapper" [style.margin-bottom]="getMessageMarginBottom(i)">
                <div class="p-2 rounded-lg text-sm relative message-bubble" [title]="'Đã gửi ' + formatTime(m.sentAt)"
                    [class.bg-blue-500]="isMessageFromCurrentUser(m.senderId)"
                    [class.text-white]="isMessageFromCurrentUser(m.senderId)"
                    [class.bg-gray-100]="!isMessageFromCurrentUser(m.senderId)"
                    [class.text-gray-800]="!isMessageFromCurrentUser(m.senderId)" [class.opacity-50]="m.isTemp"
                    [class.grouped-corner]="shouldHaveGroupedCorner(i)">
                    <div *ngIf="shouldShowSenderName(i)" class="text-xs text-gray-500 mb-1">
                        {{ getSenderName(m.senderId ?? m.sender) }}
                    </div>

                    <div class="whitespace-pre-wrap break-words">
                        {{ m.content }}
                    </div>

                    <i *ngIf="m.isTemp" class="fa-solid fa-clock text-xs absolute -bottom-1 -right-1 opacity-70"></i>
                </div>

                <div class="message-actions" [class.reverse]="isMessageFromCurrentUser(m.senderId)">
                    <app-tooltip text="Bày tỏ cảm xúc">
                        <button class="action" aria-label="react">
                            <i class="fa-regular fa-face-smile"></i>
                        </button>
                    </app-tooltip>

                    <app-tooltip text="Trả lời">
                        <button class="action" aria-label="reply">
                            <i class="fa-solid fa-reply"></i>
                        </button>
                    </app-tooltip>

                    <app-tooltip text="Xem thêm">
                        <button class="action" aria-label="more">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                    </app-tooltip>
                </div>
            </div>
        </div>

        <div *ngIf="messages.length === 0 && !isLoadingMessages" class="py-8">
            <div *ngIf="messages.length === 0 && !isLoadingMessages" class="py-8">
                <ng-container *ngIf="isGroup; else singleEmpty">
                    <div class="text-sm text-gray-500 text-center">
                        Chưa có tin nhắn trong nhóm này. Hãy bắt đầu cuộc trò chuyện!
                    </div>
                </ng-container>

                <ng-template #singleEmpty>
                    <div class="flex flex-col items-center justify-center text-center text-gray-500">
                        <img [src]="displayAvatar" alt="avatar" class="w-24 h-24 rounded-full object-cover mb-2" />
                        <div class="text-lg font-semibold">{{ displayName }}</div>
                        <div class="text-sm text-gray-500 mb-4">{{ '@' + username || '' }}</div>
                        <button class="px-4 py-1 rounded-lg bg-black text-white text-sm font-semibold cursor-pointer"
                            (click)="navigateToProfile(router, username)">
                            Xem trang cá nhân
                        </button>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>

    <div class="composer">
        <div *ngIf="selectedAttachments.length" class="attachments-preview px-2 pb-2">
            <div class="flex gap-2 overflow-auto py-1">
                <div *ngFor="let att of selectedAttachments; let idx = index" class="attachment-item relative">
                    <button type="button" class="remove-att-btn" (click)="removeAttachment(idx)" aria-label="Xóa">
                        <app-tooltip text="Gỡ file đính kèm">
                            <i class="fa-solid fa-xmark"></i>
                        </app-tooltip>
                    </button>

                    <ng-container [ngSwitch]="att.type">
                        <img *ngSwitchCase="'image'" [src]="att.url" alt="preview"
                            class="w-28 h-20 object-cover rounded" />
                        <video *ngSwitchCase="'video'" [src]="att.url" class="w-28 h-20 object-cover rounded"
                            muted></video>
                    </ng-container>
                </div>
            </div>
        </div>
        <div class="composer-inner">
            <div class="left">
                <button class="icon-btn" (click)="toggleEmojiPicker()" aria-label="Emoji">
                    <i class="fa-regular fa-face-smile"></i>
                </button>

                <div (clickOutside)="showEmojiPicker = false" class="emoji-panel" *ngIf="showEmojiPicker">
                    <emoji-mart (emojiSelect)="addEmoji($event)" [style.width.px]="320"
                        [style.height.px]="260"></emoji-mart>
                </div>
            </div>

            <div class="center">
                <textarea [(ngModel)]="text" name="text" rows="1" placeholder="Nhập tin nhắn..." class="message-input"
                    (input)="autoResize($event)" (keydown.enter)="$event.preventDefault();"></textarea>
            </div>

            <div class="right">
                <ng-container *ngIf="!text?.trim(); else hasText">
                    <button class="icon-btn" (click)="startVoiceRecording()" title="Clip âm thanh">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <button class="icon-btn" (click)="openFilePicker()" title="Thêm ảnh hoặc video">
                        <i class="fa-solid fa-image"></i>
                    </button>
                    <input #fileInput type="file" accept="image/*,video/*" multiple (change)="onFileSelected($event)"
                        hidden />

                    <button class="icon-btn" (click)="openStickerPicker()" title="Chọn một ảnh GIF hoặc nhãn dán">
                        <i class="fa-solid fa-icons"></i>
                    </button>

                    <button class="icon-btn" (click)="quickHeart()" title="Thích">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                </ng-container>

                <ng-template #hasText>
                    <button class="send-btn" (click)="send()">Gửi</button>
                </ng-template>
            </div>
        </div>
    </div>
</div>