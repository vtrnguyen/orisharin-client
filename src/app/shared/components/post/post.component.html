<div class="bg-white rounded-2xl p-4 flex gap-4 mb-3 cursor-pointer" (click)="navigateToPostDetail($event)">
    <img (click)="navigateToProfile(router, author.username)"
        [src]="author.avatarUrl || 'https://ui-avatars.com/api/?name=' + (author.fullName || author.username)"
        class="no-post-detail w-8 h-8 rounded-full object-cover cursor-pointer" alt="avatar" />
    <div class="flex-1 relative">
        <div class="flex items-center gap-2 justify-between">
            <div class="flex items-center gap-2">
                <span class="no-post-detail font-semibold text-gray-900 cursor-pointer hover:underline"
                    (click)="navigateToProfile(router, author.username)">{{ author.username }}</span>
                <span class="text-gray-400 text-xs">{{ formatTime(createdAt) }}</span>
            </div>
            <button
                class="no-post-detail w-7 h-7 flex items-center justify-center rounded-full hover:bg-gray-200 transition duration-150 cursor-pointer"
                (click)="togglePostMenu($event)">
                <i class="fa-solid fa-ellipsis text-lg text-gray-500"></i>
            </button>
            <div *ngIf="showPostMenu"
                class="absolute right-0 top-10 w-64 bg-white rounded-xl shadow-xl border border-gray-100 z-50 animate-fade-in px-2 border-gray-300"
                (click)="$event.stopPropagation()" (clickOutside)="closePostMenu()">
                <ul class="py-2">
                    <li *ngIf="isOwner(postUserName, currentUserName)"
                        class="flex items-center justify-between px-4 py-2 cursor-pointer rounded-lg transition-all hover:bg-gray-100"
                        (click)="onEditPost()">
                        <span class="font-medium text-gray-800">Chỉnh sửa</span>
                        <i class="fa-solid fa-pen-to-square text-gray-500"></i>
                    </li>
                    <li *ngIf="isOwner(postUserName, currentUserName)"
                        class="flex items-center justify-between px-4 py-2 cursor-pointer rounded-lg transition-all hover:bg-red-50"
                        (click)="onDeletePost()">
                        <span class="font-medium text-red-600">Xóa</span>
                        <i class="fa-solid fa-trash-can text-red-500"></i>
                    </li>
                    <li class="flex items-center justify-between px-4 py-2 cursor-pointer rounded-lg transition-all hover:bg-gray-100"
                        (click)="onCopyPostUrl()">
                        <span class="font-medium text-gray-800">Sao chép liên kết</span>
                        <i class="fa-solid fa-link text-gray-500"></i>
                    </li>
                    <li class="flex items-center justify-between px-4 py-2 cursor-pointer rounded-lg transition-all hover:bg-gray-100"
                        (click)="onArchivePost()">
                        <span class="font-medium text-gray-800">Lưu trữ</span>
                        <i class="fa-solid fa-bookmark text-gray-500"></i>
                    </li>
                    <li *ngIf="!isOwner(postUserName, currentUserName)"
                        class="flex items-center justify-between px-4 py-2 cursor-pointer rounded-lg transition-all hover:bg-red-50"
                        (click)="onReportPost()">
                        <span class="font-medium text-red-600">Báo cáo</span>
                        <i class="fa-solid fa-flag text-red-500"></i>
                    </li>
                </ul>
            </div>
        </div>

        <div *ngIf="isShared" class="mt-2">
            <div class="my-2 text-gray-800 text-base whitespace-pre-line" [innerHTML]="content | mentionHighlight">
            </div>
            <div (click)="navigateToPost(router, sharedPost?.author?.username, sharedPost?.post?._id)"
                class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                <div class="flex items-center gap-3 mb-2">
                    <img (click)="navigateToProfile(router, sharedPost?.author?.username)"
                        [src]="sharedPost?.author?.avatarUrl" class="w-8 h-8 rounded-full object-cover flex-shrink-0"
                        alt="avatar tác giả" />
                    <div class="leading-tight">
                        <div (click)="navigateToProfile(router, sharedPost?.author?.username)"
                            class="font-medium text-sm hover:underline cursor-pointer">
                            {{ sharedPost?.author?.fullName || sharedPost?.author?.username || 'Người dùng' }}
                        </div>
                        <div class="text-xs text-gray-500">
                            {{ formatTime(sharedPost?.post?.createdAt) }}
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-700 mt-1 whitespace-pre-line">{{ sharedPost?.post?.content || '' }}</div>

                <div *ngIf="(sharedPost?.post?.mediaUrls || []).length" class="mt-2 flex gap-2 overflow-x-auto">
                    <img *ngFor="let m of (sharedPost?.post?.mediaUrls || [])" [src]="m"
                        class="w-36 h-24 object-cover rounded-md" />
                </div>

                <div *ngIf="!sharedPost?.post.content && !(sharedPost?.post?.mediaUrls?.length)"
                    class="text-xs text-blue-600 mt-2">
                    Xem bài gốc
                </div>
            </div>
        </div>

        <!-- (non-shared) -->
        <div *ngIf="!isShared" class="mt-2 text-gray-800 text-base whitespace-pre-line"
            [innerHTML]="content | mentionHighlight">
        </div>

        <div *ngIf="!isShared && medias.length > 0" class="mt-3 flex gap-2 overflow-x-auto scrollbar-hide">
            <ng-container *ngFor="let media of medias; let i = index">
                <img *ngIf="isImage(media)" [src]="media"
                    class="no-post-detail rounded-xl border border-gray-300 max-h-72 object-cover flex-shrink-0 cursor-pointer transition-transform duration-200"
                    [class.scale-110]="zoomingIndex === i" alt="post image" (click)="openViewer(i)" />

                <video *ngIf="isVideo(media)" [src]="media" controls
                    class="no-post-detail rounded-xl border border-gray-300 max-h-72 object-contain flex-shrink-0 bg-black cursor-pointer transition-transform duration-200"
                    [class.scale-110]="zoomingIndex === i" (click)="openViewer(i)">
                </video>
            </ng-container>
        </div>
        <div class="flex gap-8 mt-4 text-gray-500 text-sm">
            <button
                class="flex items-center gap-1 transition cursor-pointer rounded-full px-4 py-2 hover:bg-gray-100 select-none"
                [class.text-red-500]="liked" [class.animate-like]="liked" (click)="toggleLike()"
                [disabled]="loadingLike">
                <i [ngClass]="liked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'"
                    class="w-5 h-5 text-lg transition-all duration-200" [class.scale-110]="liked"></i>
                <span class="leading-none">{{ likesCount }}</span>
            </button>
            <button class="flex items-center gap-1 transition cursor-pointer rounded-full px-4 py-2 hover:bg-gray-100"
                (click)="showCommentModal = true">
                <i class="fa-regular fa-comment-dots w-5 h-5 text-lg"></i>
                <span class="leading-none">{{ comments }}</span>
            </button>
            <button class="flex items-center gap-1 transition cursor-pointer rounded-full px-4 py-2 hover:bg-gray-100">
                <i class="fa-solid fa-retweet w-5 h-5 text-lg"></i>
                <span class="leading-none">{{ reposts }}</span>
            </button>
            <button (click)="openShareModal()"
                class="flex items-center gap-1 transition cursor-pointer rounded-full px-4 py-2 hover:bg-gray-100">
                <i class="fa-solid fa-share-nodes w-5 h-5 text-lg"></i>
                <span class="leading-none">{{ shares }}</span>
            </button>
        </div>
    </div>
</div>

<app-media-viewer *ngIf="showViewer" [medias]="medias" [startIndex]="viewerIndex" [onClose]="closeViewer.bind(this)">
</app-media-viewer>

<app-create-comment *ngIf="showCommentModal" [parent]="post" (close)="showCommentModal = false"
    (commentCreated)="onCommentCreated()">
</app-create-comment>

<app-confirm-modal *ngIf="showDeleteConfirm" [message]="'Bạn có chắc muốn xóa bài viết này?'" confirmText="Xóa"
    cancelText="Hủy" confirmColor="text-red-600" (confirm)="confirmDelete()" (cancel)="showDeleteConfirm = false">
</app-confirm-modal>

<app-share-post-modal *ngIf="showShareModal" [originalPost]="post"
    (close)="showShareModal = false"></app-share-post-modal>